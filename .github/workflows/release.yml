name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 python3-pip python3-venv

    - name: Install test dependencies
      run: |
        python3 -m pip install --user pytest pytest-cov coverage numpy opencv-python-headless Pillow

    - name: Run tests
      run: |
        python3 -m pytest tests/ -v --tb=short

  build-deb:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build .deb package
      run: |
        chmod +x packaging/build-deb.sh
        ./packaging/build-deb.sh "${{ steps.version.outputs.version }}"

    - name: Upload .deb artifact
      uses: actions/upload-artifact@v4
      with:
        name: deb-package
        path: packaging/*.deb

  build-flatpak:
    needs: test
    runs-on: ubuntu-22.04
    container:
      image: bilelmoussaoui/flatpak-github-actions:gnome-45
      options: --privileged
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Flatpak
      uses: flatpak/flatpak-github-actions/flatpak-builder@v6
      with:
        manifest-path: packaging/com.github.andrebfarias.extase-em-4r73.yml
        bundle: extase-em-4r73.flatpak
        cache-key: flatpak-builder-${{ github.sha }}

    - name: Upload Flatpak artifact
      uses: actions/upload-artifact@v4
      with:
        name: flatpak-package
        path: extase-em-4r73.flatpak

  release:
    needs: [build-deb, build-flatpak]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download .deb artifact
      uses: actions/download-artifact@v4
      with:
        name: deb-package
        path: artifacts/

    - name: Download Flatpak artifact
      uses: actions/download-artifact@v4
      with:
        name: flatpak-package
        path: artifacts/

    - name: List artifacts
      run: ls -la artifacts/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/*.deb
          artifacts/*.flatpak
        name: Extase em 4R73 ${{ github.ref_name }}
        body: |
          ## Extase em 4R73 ${{ github.ref_name }}

          Conversor de videos para arte ASCII colorida com GPU CUDA.

          ### Novidades nesta versao

          **Efeitos Visuais (PostFX Cyberpunk)**
          - Bloom (brilho neon)
          - Chromatic Aberration (RGB shift)
          - Scanlines CRT
          - Glitch effect
          - Motion Blur (Optical Flow)

          **Audio Reactive**
          - Modulacao por FFT em tempo real
          - 3 bandas: Bass, Mids, Treble
          - Efeitos respondem a musica

          **Style Transfer**
          - Presets: Sketch, Ink, Comic, Neon, Emboss, Cyberpunk
          - DoG/XDoG edge detection
          - Cyberpunk: neon magenta/ciano com bordas brilhantes

          **Matrix Rain**
          - Sistema de particulas GPU
          - Charsets: Katakana, Binary, ASCII

          ### Instalacao

          **Flatpak (Recomendado)**
          ```bash
          flatpak install extase-em-4r73.flatpak
          flatpak run com.github.andrebfarias.extase-em-4r73
          ```

          **Ubuntu/Debian (.deb)**
          ```bash
          sudo dpkg -i extase-em-4r73_${{ steps.version.outputs.version }}_all.deb
          sudo apt-get install -f
          ```

          ### Requisitos
          - Python 3.10+
          - GTK 3.0
          - GPU NVIDIA com CUDA 12.x (opcional, para aceleracao)
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
