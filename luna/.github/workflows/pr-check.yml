name: PR Check

on:
  pull_request:
    branches: [main, dev]

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflicts
        run: |
          git config user.email "ci@luna.local"
          git config user.name "CI Bot"
          git fetch origin ${{ github.base_ref }}
          if ! git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q "^<<<<<<<"; then
            echo "No merge conflicts detected"
          else
            echo "::error::Merge conflicts detected"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Check external IDs
        run: |
          bash src/tools/check_external_ids.sh

      - name: Quick lint
        run: |
          pip install ruff
          ruff check src/ --select=E9,F63,F7,F82 --output-format=github

      - name: Validate imports
        run: |
          pip install --upgrade pip
          pip install -r requirements-ci.txt
          python << 'PYEOF'
          import sys
          import unittest.mock as mock

          native_modules = [
              'gi', 'gi.repository', 'gi.repository.Gtk', 'gi.repository.Notify',
              'pyaudio', 'sounddevice', 'soundfile', 'whisper', 'torch', 'torchaudio',
              'sentence_transformers', 'chromadb', 'faiss', 'pystray', 'face_recognition',
              'google.genai', 'google', 'elevenlabs', 'openai', 'webrtcvad',
              'scipy', 'scipy.io', 'scipy.io.wavfile', 'ollama', 'anthropic',
              'PIL', 'PIL.Image', 'cv2', 'sklearn', 'sklearn.metrics', 'tensorflow'
          ]
          for mod in native_modules:
              sys.modules[mod] = mock.MagicMock()

          from src.app import TemploDaAlma
          print('Imports OK')
          PYEOF
        env:
          CUDA_VISIBLE_DEVICES: ""
          PYTHONPATH: ${{ github.workspace }}
