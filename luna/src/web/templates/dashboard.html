<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna Dashboard</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent: #e94560;
            --accent-secondary: #9b59b6;
            --success: #2ecc71;
            --warning: #f1c40f;
            --error: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--bg-tertiary);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--bg-tertiary);
        }

        .card-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent);
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message.user {
            background: var(--accent);
            margin-left: auto;
        }

        .message.assistant {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-secondary);
        }

        .message.streaming {
            border-color: var(--warning);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .chat-input:focus {
            outline: 2px solid var(--accent);
        }

        .send-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .entity-selector {
            margin-bottom: 20px;
        }

        .entity-selector select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--bg-tertiary);
            font-size: 1rem;
        }

        .animation-display {
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .animation-name {
            font-size: 1.2rem;
            color: var(--accent-secondary);
            margin-top: 10px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Luna Dashboard</div>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Conectando...</span>
            </div>
        </header>

        <div class="grid">
            <div class="sidebar">
                <div class="card">
                    <div class="card-header">Metricas</div>
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-value" id="apiCalls">-</div>
                            <div class="metric-label">API Calls</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="tokens">-</div>
                            <div class="metric-label">Tokens</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="latency">-</div>
                            <div class="metric-label">Latencia (ms)</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="memories">-</div>
                            <div class="metric-label">Memorias</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">Entidade Ativa</div>
                    <div class="entity-selector">
                        <select id="entitySelect">
                            <option value="luna">Luna</option>
                        </select>
                    </div>
                    <div class="animation-display">
                        <div>Animacao atual:</div>
                        <div class="animation-name" id="currentAnimation">observando</div>
                    </div>
                </div>
            </div>

            <div class="card chat-container">
                <div class="card-header">Chat</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input
                        type="text"
                        class="chat-input"
                        id="chatInput"
                        placeholder="Digite sua mensagem..."
                        autocomplete="off"
                    >
                    <button class="send-btn" id="sendBtn">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const WS_URL = `ws://${window.location.host}/ws/chat`;

        let ws = null;
        let currentStreamMessage = null;

        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                updateStatus('Conectado', true);
            };

            ws.onclose = () => {
                updateStatus('Desconectado', false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('Erro', false);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            dot.style.background = connected ? 'var(--success)' : 'var(--error)';
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'start':
                    currentStreamMessage = addMessage('', 'assistant', true);
                    break;

                case 'chunk':
                    if (currentStreamMessage) {
                        currentStreamMessage.textContent += data.text;
                        scrollToBottom();
                    }
                    break;

                case 'complete':
                    if (currentStreamMessage) {
                        currentStreamMessage.classList.remove('streaming');
                        currentStreamMessage = null;
                    }
                    document.getElementById('currentAnimation').textContent = data.animation || 'observando';
                    document.getElementById('sendBtn').disabled = false;
                    break;

                case 'error':
                    addMessage(`Erro: ${data.message}`, 'assistant');
                    document.getElementById('sendBtn').disabled = false;
                    break;

                case 'status':
                    console.log('Status:', data.message);
                    break;
            }
        }

        function addMessage(text, role, streaming = false) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = `message ${role}${streaming ? ' streaming' : ''}`;
            msg.textContent = text;
            container.appendChild(msg);
            scrollToBottom();
            return msg;
        }

        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;

            addMessage(message, 'user');
            input.value = '';
            document.getElementById('sendBtn').disabled = true;

            const entityId = document.getElementById('entitySelect').value;

            ws.send(JSON.stringify({
                message: message,
                entity_id: entityId
            }));
        }

        async function loadMetrics() {
            try {
                const [metricsRes, memoryRes] = await Promise.all([
                    fetch(`${API_BASE}/api/metrics`),
                    fetch(`${API_BASE}/api/memory/stats`)
                ]);

                const metrics = await metricsRes.json();
                const memory = await memoryRes.json();

                document.getElementById('apiCalls').textContent = metrics.api_calls || 0;
                document.getElementById('tokens').textContent = metrics.tokens_used || 0;
                document.getElementById('latency').textContent = Math.round(metrics.avg_latency_ms || 0);
                document.getElementById('memories').textContent = memory.total_memories || 0;
            } catch (e) {
                console.error('Erro ao carregar metricas:', e);
            }
        }

        async function loadEntities() {
            try {
                const res = await fetch(`${API_BASE}/api/entities`);
                const data = await res.json();

                const select = document.getElementById('entitySelect');
                select.innerHTML = '';

                data.entities.forEach(entity => {
                    if (entity.available) {
                        const option = document.createElement('option');
                        option.value = entity.id;
                        option.textContent = entity.name;
                        select.appendChild(option);
                    }
                });
            } catch (e) {
                console.error('Erro ao carregar entidades:', e);
            }
        }

        document.getElementById('sendBtn').addEventListener('click', sendMessage);

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        connectWebSocket();
        loadMetrics();
        loadEntities();

        setInterval(loadMetrics, 30000);
    </script>
</body>
</html>
