#!/bin/bash

echo "=== Pre-commit Hook: Extase em 4R73 ==="

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "[OK] Nenhum arquivo staged"
    exit 0
fi

# ============================================================================
# PROTOCOLO 1: ANTI-EMOJI (Zero Tolerância)
# ============================================================================
echo "[1/5] Verificando presença de emojis..."
EMOJI_PATTERN='[\x{1F600}-\x{1F64F}]|[\x{1F300}-\x{1F5FF}]|[\x{1F680}-\x{1F6FF}]|[\x{2600}-\x{26FF}]|[\x{2700}-\x{27BF}]|[\x{1F900}-\x{1F9FF}]'

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Ignora arquivos binários e de mídia
        case "$file" in
            *.png|*.jpg|*.jpeg|*.gif|*.svg|*.ico|*.mp4|*.mp3|*.zip|*.tar|*.gz) continue ;;
        esac

        if grep -P "$EMOJI_PATTERN" "$file" > /dev/null 2>&1; then
            echo "[BLOQUEIO] Emoji detectado em: $file"
            echo "   Protocolo Luna: ZERO EMOJIS. Remova antes de commitar."
            exit 1
        fi
    fi
done
echo "[OK] Nenhum emoji detectado"

# ============================================================================
# PROTOCOLO 2: ANONIMATO (Proteção contra vazamento de dados)
# ============================================================================
echo "[2/5] Verificando vazamento de informações sensíveis..."

# Padrões de risco (não inclui variáveis de ambiente legítimas em .env ou config.ini)
SENSITIVE_PATTERNS=(
    'password\s*=\s*["\x27][^"\x27]+["\x27]'
    'api[_-]?key\s*=\s*["\x27][A-Za-z0-9_-]{20,}["\x27]'
    'secret[_-]?key\s*=\s*["\x27][^"\x27]+["\x27]'
    'token\s*=\s*["\x27](ghp_|sk-ant-|AIza)[A-Za-z0-9_-]+["\x27]'
    'aws[_-]?secret[_-]?access[_-]?key'
    'BEGIN (RSA |DSA |EC )?PRIVATE KEY'
    'andre\.dsbf@gmail\.com.*senha'
    'andrefarias@mec\.gov\.br.*senha'
)

for file in $STAGED_FILES; do
    # Ignora arquivos de configuração legítimos
    case "$file" in
        .env|config.ini|.zsh_secrets|*credentials*|*.pem|*.key)
            echo "   [INFO] Ignorando arquivo de config: $file"
            continue
            ;;
        *.png|*.jpg|*.jpeg|*.gif|*.svg|*.ico|*.mp4|*.mp3|*.zip|*.tar|*.gz)
            continue
            ;;
    esac

    if [ -f "$file" ]; then
        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if grep -iP "$pattern" "$file" > /dev/null 2>&1; then
                echo "[BLOQUEIO] Possível vazamento em: $file"
                echo "   Padrão detectado: $pattern"
                echo "   Verifique se há senhas/tokens hardcoded."
                exit 1
            fi
        done
    fi
done
echo "[OK] Nenhum vazamento detectado"

# ============================================================================
# PROTOCOLO 3: VALIDAÇÃO PYTHON (Sintaxe)
# ============================================================================
STAGED_PY_FILES=$(echo "$STAGED_FILES" | grep '\.py$')

if [ -n "$STAGED_PY_FILES" ]; then
    echo "[3/5] Verificando sintaxe Python..."
    for file in $STAGED_PY_FILES; do
        if [ -f "$file" ]; then
            python3 -m py_compile "$file" 2>/dev/null
            if [ $? -ne 0 ]; then
                echo "[ERRO] Sintaxe invalida: $file"
                exit 1
            fi
        fi
    done
    echo "[OK] Sintaxe valida"
else
    echo "[3/5] Nenhum arquivo Python para validar"
fi

# ============================================================================
# PROTOCOLO 4: VALIDAÇÃO DE IMPORTS (Somente se há Python)
# ============================================================================
if [ -n "$STAGED_PY_FILES" ]; then
    echo "[4/5] Verificando imports..."
    MAIN_IMPORT_TEST="from src.app.app import App"
    python3 -c "$MAIN_IMPORT_TEST" 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "[AVISO] Import principal falhou (pode ser ambiente)"
    fi
    echo "[OK] Imports verificados"
else
    echo "[4/5] Nenhum import para validar"
fi

# ============================================================================
# PROTOCOLO 5: VERIFICAÇÃO DE TAMANHO (Arquivos grandes)
# ============================================================================
echo "[5/5] Verificando arquivos grandes..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file")
        if [ "$SIZE" -gt 500000 ]; then
            echo "[BLOQUEIO] Arquivo muito grande: $file ($SIZE bytes)"
            echo "   Arquivos >500KB devem ir para data_input/ ou assets/"
            exit 1
        elif [ "$SIZE" -gt 100000 ]; then
            echo "[AVISO] Arquivo grande: $file ($SIZE bytes)"
        fi
    fi
done
echo "[OK] Tamanhos verificados"

echo "=== Pre-commit concluido ==="
exit 0
