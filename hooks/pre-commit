#!/bin/bash

echo "=== Pre-commit Hook: Extase em 4R73 ==="

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')

if [ -z "$STAGED_PY_FILES" ]; then
    echo "[OK] Nenhum arquivo Python staged"
    exit 0
fi

echo "[1/3] Verificando sintaxe Python..."
for file in $STAGED_PY_FILES; do
    if [ -f "$file" ]; then
        python3 -m py_compile "$file" 2>/dev/null
        if [ $? -ne 0 ]; then
            echo "[ERRO] Sintaxe invalida: $file"
            exit 1
        fi
    fi
done
echo "[OK] Sintaxe valida"

echo "[2/3] Verificando imports..."
MAIN_IMPORT_TEST="from src.app.app import App"
python3 -c "$MAIN_IMPORT_TEST" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "[AVISO] Import principal falhou (pode ser ambiente)"
fi
echo "[OK] Imports verificados"

echo "[3/3] Verificando arquivos grandes..."
for file in $STAGED_PY_FILES; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file")
        if [ "$SIZE" -gt 100000 ]; then
            echo "[AVISO] Arquivo grande: $file ($SIZE bytes)"
        fi
    fi
done
echo "[OK] Tamanhos verificados"

echo "=== Pre-commit concluido ==="
exit 0
