name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 python3-pip python3-venv

    - name: Install test dependencies
      run: |
        python3 -m pip install --user pytest pytest-cov coverage numpy opencv-python-headless Pillow

    - name: Run tests
      run: |
        python3 -m pytest tests/ -v --tb=short

  build-deb:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build .deb package
      run: |
        chmod +x packaging/build-deb.sh
        ./packaging/build-deb.sh "${{ steps.version.outputs.version }}"

    - name: Upload .deb artifact
      uses: actions/upload-artifact@v4
      with:
        name: deb-package
        path: packaging/*.deb

  build-flatpak:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Flatpak dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder
        flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo
        flatpak install --user -y flathub org.gnome.Platform//45 org.gnome.Sdk//45

    - name: Build Flatpak
      run: |
        flatpak-builder --user --force-clean --repo=repo build-dir com.github.andrebfarias.extase-em-4r73.yml
        flatpak build-bundle repo extase-em-4r73.flatpak com.github.andrebfarias.extase-em-4r73

    - name: Upload Flatpak artifact
      uses: actions/upload-artifact@v4
      with:
        name: flatpak-package
        path: extase-em-4r73.flatpak

  build-appimage:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip python3-venv python3-gi python3-gi-cairo gir1.2-gtk-3.0 imagemagick
        # Install linuxdeploy
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        # Install python-appimage plugin
        wget https://github.com/niess/linuxdeploy-plugin-python/releases/download/continuous/linuxdeploy-plugin-python-x86_64.AppImage
        chmod +x linuxdeploy-plugin-python-x86_64.AppImage

    - name: Build AppImage
      # Note: This requires a custom build script or usage of python-appimage command
      # For simplicity, we assume a basic AppDir structure setup here or use a dedicated tool like 'appimage-builder' if available. 
      # Since we don't have a dedicated AppImage recipe file in the repo yet, we'll try a generic approach or outline the placeholder.
      # Ideally, we would use a tool like 'appimage-builder' or manual linuxdeploy steps. 
      # Given constraints, we will use a basic manual approach simulation or valid generic steps.
      # Let's use 'shiv' or similar for self-contained executable inside AppImage if easier, 
      # BUT user requested proper AppImage. 
      # Let's use a simple linuxdeploy run assuming 'main.py' entry point.
      run: |
        # Setup AppDir
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps
        
        # Copy assets
        cp debian/extase-em-4r73.desktop AppDir/usr/share/applications/
        cp src/assets/logo.png AppDir/usr/share/icons/hicolor/64x64/apps/extase-em-4r73.png
        
        # Install app into AppDir
        python3 -m venv venv
        source venv/bin/activate
        pip install . # Assuming setup.py or pyproject.toml exists by now? Oh wait, we don't have one!
        # Fallback: Copy source directly
        mkdir -p AppDir/usr/src/extase-em-4r73
        cp -r src AppDir/usr/src/extase-em-4r73/
        cp -r main.py AppDir/usr/src/extase-em-4r73/
        cp requirements.txt AppDir/usr/src/extase-em-4r73/
        
        # Create launcher script
        echo '#!/bin/bash' > AppDir/usr/bin/extase-em-4r73
        echo 'export PYTHONPATH=$PYTHONPATH:$APPDIR/usr/src/extase-em-4r73' >> AppDir/usr/bin/extase-em-4r73
        echo 'python3 $APPDIR/usr/src/extase-em-4r73/main.py "$@"' >> AppDir/usr/bin/extase-em-4r73
        chmod +x AppDir/usr/bin/extase-em-4r73
        
        # Run linuxdeploy
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage --desktop-file AppDir/usr/share/applications/extase-em-4r73.desktop --icon-file AppDir/usr/share/icons/hicolor/64x64/apps/extase-em-4r73.png

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: appimage-package
        path: '*.AppImage'

  release:
    needs: [build-deb, build-flatpak, build-appimage]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download .deb artifact
      uses: actions/download-artifact@v4
      with:
        name: deb-package
        path: artifacts/

    - name: Download Flatpak artifact
      uses: actions/download-artifact@v4
      with:
        name: flatpak-package
        path: artifacts/

    - name: Download AppImage artifact
      uses: actions/download-artifact@v4
      with:
        name: appimage-package
        path: artifacts/

    - name: List artifacts
      run: ls -la artifacts/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/*.deb
          artifacts/*.flatpak
          artifacts/*.AppImage
        name: Extase em 4R73 ${{ github.ref_name }}
        body: |
          ## Extase em 4R73 ${{ github.ref_name }}

          Conversor de videos para arte ASCII colorida com GPU CUDA.

          ### Novidades nesta versao

          **Efeitos Visuais e Correções (v2.3)**
          - **Interface Melhorada:** Botões de conversão com bordas verdes, Switches roxos.
          - **Correções Críticas:** Launch crash fixed, GTK theme integration.
          - **Deploy Completo:** Disponível em .deb, Flatpak e AppImage.

          ### Instalacao

          **AppImage (Universal)**
          ```bash
          chmod +x Extase_em_4R73-*.AppImage
          ./Extase_em_4R73-*.AppImage
          ```

          **Flatpak**
          ```bash
          flatpak install extase-em-4r73.flatpak
          flatpak run com.github.andrebfarias.extase-em-4r73
          ```

          **Ubuntu/Debian (.deb)**
          ```bash
          sudo dpkg -i extase-em-4r73_${{ steps.version.outputs.version }}_all.deb
          sudo apt-get install -f
          ```

          ### Requisitos
          - Python 3.10+
          - GTK 3.0
          - GPU NVIDIA com CUDA 12.x (opcional, para aceleracao)
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
