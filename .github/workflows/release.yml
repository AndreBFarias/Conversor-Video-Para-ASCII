name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 python3-pip python3-venv

    - name: Install test dependencies
      run: |
        python3 -m pip install --user pytest pytest-cov coverage numpy opencv-python-headless Pillow

    - name: Run tests
      run: |
        python3 -m pytest tests/ -v --tb=short

  build-deb:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build .deb package
      run: |
        chmod +x packaging/build-deb.sh
        ./packaging/build-deb.sh "${{ steps.version.outputs.version }}"

    - name: Upload .deb artifact
      uses: actions/upload-artifact@v4
      with:
        name: deb-package
        path: packaging/*.deb

  build-flatpak:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Flatpak dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder
        flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo
        flatpak install --user -y flathub org.gnome.Platform//45 org.gnome.Sdk//45

    - name: Build Flatpak
      run: |
        flatpak-builder --user --force-clean --repo=repo build-dir com.github.andrebfarias.extase-em-4r73.yml
        flatpak build-bundle repo extase-em-4r73.flatpak com.github.andrebfarias.extase-em-4r73

    - name: Upload Flatpak artifact
      uses: actions/upload-artifact@v4
      with:
        name: flatpak-package
        path: extase-em-4r73.flatpak

  build-appimage:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip python3-venv python3-gi python3-gi-cairo gir1.2-gtk-3.0 imagemagick portaudio19-dev libfuse2 libwebp-dev
        # Install linuxdeploy
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        # Install python-appimage plugin
        wget https://github.com/niess/linuxdeploy-plugin-python/releases/download/continuous/linuxdeploy-plugin-python-x86_64.AppImage
        chmod +x linuxdeploy-plugin-python-x86_64.AppImage

    - name: Build AppImage
      run: |
        # 1. Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps
        mkdir -p AppDir/usr/lib/python3.10/site-packages
        mkdir -p AppDir/usr/src/extase-em-4r73

        # 2. Create desktop file for AppImage (relative Exec path)
        cat > AppDir/usr/share/applications/extase-em-4r73.desktop << 'DESKTOP'
        [Desktop Entry]
        Version=1.1
        Name=Extase em 4R73
        Comment=Conversor de Videos e Imagens para Arte ASCII
        Exec=extase-em-4r73
        Icon=extase-em-4r73
        Terminal=false
        Type=Application
        Categories=Video;AudioVideo;Graphics;
        StartupNotify=true
        DESKTOP
        sed -i 's/^        //' AppDir/usr/share/applications/extase-em-4r73.desktop

        # 3. Copy and resize icon
        convert assets/logo.png -resize 64x64! AppDir/usr/share/icons/hicolor/64x64/apps/extase-em-4r73.png

        # 4. Install Python dependencies into AppDir (versao CPU leve)
        # PyTorch CPU-only primeiro (200MB vs 2GB CUDA)
        pip3 install --ignore-installed --prefix AppDir/usr \
          torch==2.5.1+cpu torchvision==0.20.1+cpu \
          --index-url https://download.pytorch.org/whl/cpu
        # Resto das dependencias
        pip3 install --ignore-installed --prefix AppDir/usr -r requirements-appimage.txt

        # 5. Copy source code
        cp -r src AppDir/usr/src/extase-em-4r73/
        cp -r assets AppDir/usr/src/extase-em-4r73/
        cp main.py AppDir/usr/src/extase-em-4r73/
        cp config.ini AppDir/usr/src/extase-em-4r73/

        # 6. Create launcher in usr/bin
        cat > AppDir/usr/bin/extase-em-4r73 << 'LAUNCHER'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
        APPDIR="$(dirname "$(dirname "$HERE")")"
        export PYTHONPATH="$APPDIR/usr/lib/python3.10/site-packages:$APPDIR/usr/src/extase-em-4r73:$PYTHONPATH"
        LIBDIRS=$(find "$APPDIR/usr/lib/python3.10/site-packages" -name "*.libs" -type d 2>/dev/null | tr '\n' ':')
        export LD_LIBRARY_PATH="$LIBDIRS$APPDIR/usr/lib:$LD_LIBRARY_PATH"
        cd "$APPDIR/usr/src/extase-em-4r73"
        exec python3 "$APPDIR/usr/src/extase-em-4r73/main.py" "$@"
        LAUNCHER
        sed -i 's/^        //' AppDir/usr/bin/extase-em-4r73
        chmod +x AppDir/usr/bin/extase-em-4r73

        # 7. Create AppRun (root entry point)
        cat > AppDir/AppRun << 'APPRUN'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export PYTHONPATH="$HERE/usr/lib/python3.10/site-packages:$HERE/usr/src/extase-em-4r73:$PYTHONPATH"
        LIBDIRS=$(find "$HERE/usr/lib/python3.10/site-packages" -name "*.libs" -type d 2>/dev/null | tr '\n' ':')
        export LD_LIBRARY_PATH="$LIBDIRS$HERE/usr/lib:$LD_LIBRARY_PATH"
        cd "$HERE/usr/src/extase-em-4r73"
        exec python3 "$HERE/usr/src/extase-em-4r73/main.py" "$@"
        APPRUN
        sed -i 's/^        //' AppDir/AppRun
        chmod +x AppDir/AppRun

        # 8. Run linuxdeploy to generate AppImage
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage \
          --desktop-file AppDir/usr/share/applications/extase-em-4r73.desktop \
          --icon-file AppDir/usr/share/icons/hicolor/64x64/apps/extase-em-4r73.png

        # 9. Rename output to standardized name
        mv Extase_em_4R73*.AppImage Extase_em_4R73-${{ steps.version.outputs.version }}-x86_64.AppImage || true

        # 10. Verify size (GitHub limit: 2GB)
        APPIMAGE_SIZE=$(stat -c%s "Extase_em_4R73-${{ steps.version.outputs.version }}-x86_64.AppImage" 2>/dev/null || echo 0)
        APPIMAGE_SIZE_MB=$((APPIMAGE_SIZE / 1024 / 1024))
        echo "AppImage size: ${APPIMAGE_SIZE_MB}MB"
        if [ "$APPIMAGE_SIZE" -gt 2147483648 ]; then
          echo "ERROR: AppImage exceeds GitHub 2GB limit!"
          exit 1
        fi

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: appimage-package
        path: 'Extase_em_4R73-*.AppImage'

  release:
    needs: [build-deb, build-flatpak, build-appimage]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download .deb artifact
      uses: actions/download-artifact@v4
      with:
        name: deb-package
        path: artifacts/

    - name: Download Flatpak artifact
      uses: actions/download-artifact@v4
      with:
        name: flatpak-package
        path: artifacts/

    - name: Download AppImage artifact
      uses: actions/download-artifact@v4
      with:
        name: appimage-package
        path: artifacts/

    - name: List artifacts
      run: |
        echo "=== Artifacts downloaded ==="
        ls -lh artifacts/
        echo "=== Total size ==="
        du -sh artifacts/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/*.deb
          artifacts/*.flatpak
          artifacts/*.AppImage
        name: Extase em 4R73 ${{ github.ref_name }}
        body: |
          ## Extase em 4R73 ${{ github.ref_name }}

          Conversor de videos para arte ASCII colorida com GPU CUDA.

          Veja CHANGELOG.md para detalhes das mudancas nesta versao.

          ### Instalacao

          **AppImage (Universal)**
          ```bash
          chmod +x Extase_em_4R73-*.AppImage
          ./Extase_em_4R73-*.AppImage
          ```

          **Flatpak**
          ```bash
          flatpak install extase-em-4r73.flatpak
          flatpak run com.github.andrebfarias.extase-em-4r73
          ```

          **Ubuntu/Debian (.deb)**
          ```bash
          sudo dpkg -i extase-em-4r73_${{ steps.version.outputs.version }}_all.deb
          sudo apt-get install -f
          ```

          ### Requisitos
          - Python 3.10+
          - GTK 3.0
          - GPU NVIDIA com CUDA 12.x (opcional, para aceleracao)
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
