name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 python3-pip python3-venv

    - name: Install test dependencies
      run: |
        python3 -m pip install --user pytest pytest-cov coverage numpy opencv-python-headless Pillow

    - name: Run tests
      run: |
        python3 -m pytest tests/ -v --tb=short

  build-deb:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build .deb package
      run: |
        chmod +x packaging/build-deb.sh
        ./packaging/build-deb.sh "${{ steps.version.outputs.version }}"

    - name: Upload .deb artifact
      uses: actions/upload-artifact@v4
      with:
        name: deb-package
        path: packaging/*.deb

  build-flatpak:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Flatpak dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder
        flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo
        flatpak install --user -y flathub org.gnome.Platform//45 org.gnome.Sdk//45

    - name: Build Flatpak
      run: |
        flatpak-builder --user --force-clean --repo=repo build-dir com.github.andrebfarias.extase-em-4r73.yml
        flatpak build-bundle repo extase-em-4r73.flatpak com.github.andrebfarias.extase-em-4r73

    - name: Upload Flatpak artifact
      uses: actions/upload-artifact@v4
      with:
        name: flatpak-package
        path: extase-em-4r73.flatpak

  build-appimage:
    needs: test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip python3-venv python3-gi python3-gi-cairo gir1.2-gtk-3.0 imagemagick portaudio19-dev libfuse2
        # Install linuxdeploy
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        # Install python-appimage plugin
        wget https://github.com/niess/linuxdeploy-plugin-python/releases/download/continuous/linuxdeploy-plugin-python-x86_64.AppImage
        chmod +x linuxdeploy-plugin-python-x86_64.AppImage

    - name: Build AppImage
      run: |
        # 1. Create a dummy setup.py to satisfy pip and linuxdeploy-plugin-python
        echo "from setuptools import setup, find_packages" > setup.py
        echo "setup(name='extase-em-4r73', version='${{ steps.version.outputs.version }}', packages=find_packages(), py_modules=['main'], install_requires=[])" >> setup.py
        # Note: requirements are handled via pip install -r requirements.txt usually, but plugin checks this.
        
        # 2. Setup AppDir structure
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps
        
        # 3. Copy assets
        cp debian/extase-em-4r73.desktop AppDir/usr/share/applications/
        cp assets/logo.png AppDir/usr/share/icons/hicolor/64x64/apps/extase-em-4r73.png
        
        # 4. Install dependencies and app into AppDir manually to be safe
        # Create a site-packages directory in AppDir
        mkdir -p AppDir/usr/lib/python3.10/site-packages
        export PYTHONPATH=$PWD/AppDir/usr/lib/python3.10/site-packages:$PYTHONPATH
        
        # Install requirements
        pip3 install --ignore-installed --target AppDir/usr/lib/python3.10/site-packages -r requirements.txt
        
        # Copy source code to AppDir
        mkdir -p AppDir/usr/src/extase-em-4r73
        cp -r src AppDir/usr/src/extase-em-4r73/
        cp main.py AppDir/usr/src/extase-em-4r73/
        
        # 5. Create AppRun script
        cat > AppDir/AppRun <<EOF
        #!/bin/bash
        HERE="\$(dirname "\$(readlink -f "\${0}")")"
        export PYTHONPATH="\$HERE/usr/lib/python3.10/site-packages:\$HERE/usr/src/extase-em-4r73:\$PYTHONPATH"
        export LD_LIBRARY_PATH="\$HERE/usr/lib:\$LD_LIBRARY_PATH"
        exec python3 "\$HERE/usr/src/extase-em-4r73/main.py" "\$@"
        EOF
        chmod +x AppDir/AppRun
        
        # 6. Run linuxdeploy (without python plugin for now to avoid complexity, just bundling libs)
        # We rely on system python being present on target or bundle it later. 
        # For simplicity in this fix, we assume user has python (like .deb). 
        # BUT user wanted AppImage to be self-contained? 
        # The python plugin is what makes it self-contained. Let's try to use it with the setup.py we made.
        
        # RETRY with Plugin using the generated setup.py
        # We need to clean AppDir/AppRun if we want plugin to generate it, 
        # OR we keep our custom AppRun if we are doing manual mode.
        # Let's try the PLUGIN mode one last time with the setup.py existing.
        
        rm AppDir/AppRun # Let plugin generate it if possible, or use ours if we don't use plugin.
        
        # Valid Standard AppImage Build with Plugin:
        # pip install . --prefix=AppDir/usr
        export PIP_PREFIX=AppDir/usr
        pip3 install . -r requirements.txt
        
        # Run linuxdeploy with python plugin
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin python --output appimage --desktop-file AppDir/usr/share/applications/extase-em-4r73.desktop --icon-file AppDir/usr/share/icons/hicolor/64x64/apps/extase-em-4r73.png

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: appimage-package
        path: '*.AppImage'

  release:
    needs: [build-deb, build-flatpak, build-appimage]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download .deb artifact
      uses: actions/download-artifact@v4
      with:
        name: deb-package
        path: artifacts/

    - name: Download Flatpak artifact
      uses: actions/download-artifact@v4
      with:
        name: flatpak-package
        path: artifacts/

    - name: Download AppImage artifact
      uses: actions/download-artifact@v4
      with:
        name: appimage-package
        path: artifacts/

    - name: List artifacts
      run: ls -la artifacts/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/*.deb
          artifacts/*.flatpak
          artifacts/*.AppImage
        name: Extase em 4R73 ${{ github.ref_name }}
        body: |
          ## Extase em 4R73 ${{ github.ref_name }}

          Conversor de videos para arte ASCII colorida com GPU CUDA.

          ### Novidades nesta versao

          **Efeitos Visuais e Correções (v2.3)**
          - **Interface Melhorada:** Botões de conversão com bordas verdes, Switches roxos.
          - **Correções Críticas:** Launch crash fixed, GTK theme integration.
          - **Deploy Completo:** Disponível em .deb, Flatpak e AppImage.

          ### Instalacao

          **AppImage (Universal)**
          ```bash
          chmod +x Extase_em_4R73-*.AppImage
          ./Extase_em_4R73-*.AppImage
          ```

          **Flatpak**
          ```bash
          flatpak install extase-em-4r73.flatpak
          flatpak run com.github.andrebfarias.extase-em-4r73
          ```

          **Ubuntu/Debian (.deb)**
          ```bash
          sudo dpkg -i extase-em-4r73_${{ steps.version.outputs.version }}_all.deb
          sudo apt-get install -f
          ```

          ### Requisitos
          - Python 3.10+
          - GTK 3.0
          - GPU NVIDIA com CUDA 12.x (opcional, para aceleracao)
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
