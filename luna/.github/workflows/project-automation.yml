name: Project Automation

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened]
  pull_request:
    types: [opened, closed]
  schedule:
    - cron: '0 6 * * *'

permissions:
  issues: write
  pull-requests: write

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'issues' && github.event.action == 'opened' && vars.PROJECT_URL != ''
    continue-on-error: true
    steps:
      - uses: actions/add-to-project@v1.0.2
        with:
          project-url: ${{ vars.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
        continue-on-error: true

  close-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const title = context.payload.pull_request.title || '';
            const combined = `${title}\n${body}`;
            const matches = combined.match(/(?:closes|fixes|resolves|close|fix|resolve)\s*:?\s*#(\d+)/gi) || [];

            if (matches.length === 0) {
              console.log('Nenhuma issue linkada encontrada');
              return;
            }

            for (const match of matches) {
              const num = match.match(/\d+/)[0];
              const issueNumber = parseInt(num);

              try {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });
                console.log(`Issue #${issueNumber} fechada`);

                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: 'status:in-progress'
                  });
                } catch (labelError) {
                  // Label nao existe, ignorar
                }
              } catch (error) {
                console.log(`Erro ao fechar issue #${issueNumber}: ${error.message}`);
              }
            }

  stale:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/stale@v9
        with:
          stale-issue-message: 'Esta issue esta inativa ha 14 dias. Sera fechada em 7 dias se nao houver atividade.'
          stale-pr-message: 'Este PR esta inativo ha 14 dias. Sera fechado em 7 dias se nao houver atividade.'
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          days-before-stale: 14
          days-before-close: 21
          exempt-issue-labels: 'P0-critical,P1-high,pinned'
          exempt-pr-labels: 'P0-critical,P1-high,pinned'
          operations-per-run: 30
